@page "/organizations/create"

@inject NavigationManager Navigation
@inject IAccessTokenProvider AuthenticationService

@using Artemis.Web.Shared.Organizations
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

    <EditForm Model="@model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group">
            <label>Name</label>
            <InputText class="form-control" @bind-Value="model.Name" />
        </div>

        <div class="form-group">
            <label>Description</label>
            <InputTextArea class="form-control" @bind-Value="model.Description" />
        </div>

        <button class="btn btn-primary" type="submit">Submit</button>
    </EditForm>

@code {
    private CreateOrganization model = new CreateOrganization();

    private async Task HandleValidSubmit()
    {
        var httpClient = new HttpClient();
        httpClient.BaseAddress = new Uri(Navigation.BaseUri);

        var tokenResult = await AuthenticationService.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            httpClient.DefaultRequestHeaders.Add("Authorization", $"Bearer {token.Value}");
            await httpClient.PostJsonAsync("/api/organization", model);
        }

        Navigation.NavigateTo("organizations");
    }
}